Чтобы хранить состояние клиентов добавил структуру client_state, функции dostuff работает без цикла, а просто через свитч проверяет состояние клиента, это сделано чтобы не блокировать поток выполнения только одним клиентом.